var a=a||{};a.sitesettings={},a.router={defloc:"/blog/list/",init:function(){$.ajax({type:"GET",url:"./api/sitesettings/load/",data:{},dataType:"json",cache:!1,success:function(t){a.sitesettings=t.site_settings,t.success?(window.addEventListener("hashchange",(function(t){a.router.parseHash(window.location.hash.substring(1),t.oldURL.split("#")[1])})),a.router.parseHash(window.location.hash.substring(1),"/")):alert("Error loading site settings, check config.php")}}).done((function(){}))},parseHash:function(t,e){if(t){var n=t.split("/").filter((function(t){return""!=t}));void 0!==e&&e.split("/").filter((function(t){return""!=t})),n.length>0&&"blog"==n[0]?"list"==n[1]?a.blog.listPage():"edit"==n[1]&&a.blog.edit.editPage(n[2]):window.location.hash=a.router.defloc}else window.location.hash=a.router.defloc}},a.s=function(){var t={loader:{fs:{create:function(){$("body").append('<div id="fsloader"><span><i class="spinner">&#9696;</i></span></div>'),setTimeout((function(){a.s.loader.fs.remove()}),8e3)},remove:function(){$("#fsloader").fadeOut(50,(function(){$(this).remove()}))}}},growl:{create:function(t,e,n){var i=n.duration||2e3;document.getElementById("growlc")||$("body").append('<div id="growlc"></div>');var o=a.s.createToken(),s='<div class="notification" id="growl_notif_'+o+'">';s+='<i class="close" data-action="remove_growl_notification" style="font-style:normal;">&times;</i>',s+="<h5>"+t+"</h5>",e&&(s+="<p>"+e+"</p>"),s+="</div>",$("#growlc").append(s);var c=$("#growl_notif_"+o);c.fadeIn(200,(function(){$('i[data-action="remove_growl_notification"]',c).unbind("click").click((function(){a.s.growl.remove(o)})),setTimeout((function(){a.s.growl.remove(o)}),i)}))},remove:function(t){var e=$("#growl_notif_"+t);e.fadeOut(200,(function(){e.remove(),0==$("#growlc>div.notification").length&&$("#growlc").remove()}))}},popup:{winlist:[],create:function(t){var e=t.width||400,n=t.height||300,i=t.title||"",o=t.content||"",s=t.show_actions||!1,c=t.actions_content||"",l=t.btntitle||"",r=t.add_cancel||!1,d=t.ready||function(){},u=t.close||function(){},p=t.submit||function(){},f=t.submit_no_loader||!1,g=t.bgcolor||"#fff",h=a.s.createToken(),b="";b+='<div class="popup" id="popupid_'+h+'">',b+='<div class="popupwin" style="background-color:'+g+';">',b+='<div class="popupwinbar">',b+="<h4>"+i+"</h4>",b+="</div>",b+='<i class="close">&times;</i>',b+='<div class="ic">'+o+"</div>",(l||s)&&(b+='<div class="actions" style="background-color:#fff;"><div class="row-table-nobr autowidth">',c?b+=c:(r&&(b+='<div class="col left"><button class="btn btn-link" data-btn="btn_cancel"><span>Cancel</span></button></div>'),l&&(b+='<div class="col right"><button class="btn btn-success" data-btn="btn_submit"><i class="fa fa-spinner fa-spin" style="display:none;"></i><span>'+l+"</span></button></div>")),b+="</div></div>"),b+="</div>",b+="</div>",0==a.s.popup.winlist.length&&($("body").append('<div id="popup_container"></div>'),$("#popup_container").fadeIn(50,(function(){}))),a.s.popup.winlist.push(h),$("#popup_container .popup").attr("data-active-popup","false"),$("#popup_container").append(b);var v=window.innerWidth,m=window.innerHeight;v<e&&(e=v),m<n&&(n=m),v<=768&&(e=v,n=m);var y=e/2,w=n-95,k=n-45,_=e-41,T=m/2-n/2,j=$("#popupid_"+h+" .popupwin");return $(j).css("width",e+"px"),$(j).css("height",n+"px"),$(j).css("left","calc(50% - "+y+"px)"),$(j).css("top",T+"px"),$("i.close",j).css("left",_+"px"),l||s?$(".ic",j).css("height",w+"px"):$(".ic",j).css("height",k+"px"),$("#popupid_"+h+" .popupwin").animate({opacity:1},200),a.s.keymng.escList.push({token:h,run:function(){a.s.popup.remove(h,u)}}),l&&$("#popupid_"+h+' button[data-btn="btn_submit"]').unbind("click").click((function(){f||a.s.loader.fs.create(),p((function(t){void 0===t&&(t=!0),t&&a.s.popup.remove(h,u),f||a.s.loader.fs.remove()}))})),r&&$("#popupid_"+h+' button[data-btn="btn_cancel"]').unbind("click").click((function(){a.s.popup.remove(h,u)})),$("i.close",j).click((function(){a.s.popup.remove(h,u)})),d(h),setTimeout((function(){$("#popup_container").children().length>0?0==$("#popup_container").is(":visible")&&$("#popup_container").fadeIn(50,(function(){})):(a.s.popup.winlist=[],$("#popup_container").remove())}),500),h},remove:function(t,e){$("#popupid_"+t).addClass("remove"),$("#popupid_"+t).fadeOut(100,(function(){$("#popupid_"+t).remove(),a.s.keymng.escRemove(t),a.s.popup.winlist.splice(a.s.popup.winlist.indexOf(t),1),0==a.s.popup.winlist.length?$("#popup_container").fadeOut(100,(function(){$(this).remove(),e()})):e()}))},notify:function(t,e,n){var i=a.s.popup.create({width:300,height:100,title:t,content:'<div class="icontainer space">'+e+"</div>"});setTimeout((function(){a.s.popup.remove(i,(function(){}))}),n)}},tabbox:{init:function(){$("div.itabbox").each((function(){t.tabbox.initTabBox(this,!1)}))},initTabBox:function(t,e){var a=0,n=$(">ul.itabs>li",t),i=$(">.itabcontent>div",t);if($(n).removeClass("active"),$(i).hide(),"number"==typeof e&&i.length>=e&&(a=e),0==n.length||n.length!=i.length)return!1;$(n[a]).addClass("active"),$(i[a]).show(),$(n).unbind("click").click((function(){$(">ul.itabs>li.active",t).removeClass("active"),$(this).addClass("active"),$(i).hide(),$(i[$(this).index()]).show()}))},changeTab:function(t,e){var a=0,n=$(">ul.itabs>li",t),i=$(">.itabcontent>div",t);if($(n).removeClass("active"),$(i).hide(),"number"==typeof e&&i.length>=e?a=e:"string"==typeof e&&n.each((function(t,n){$(n).attr("data-tab-id")==e&&(a=t)})),0==n.length||n.length!=i.length)return!1;$(n[a]).addClass("active"),$(i[a]).show()}},keymng:{init:function(){$(document).keydown((function(t){27==t.which&&a.s.keymng.escKey()}))},escList:[],escKey:function(){0!==a.s.keymng.escList.length&&a.s.keymng.escList[a.s.keymng.escList.length-1].run()},escRemove:function(t){if(0!==a.s.keymng.escList.length)for(i=0;i<a.s.keymng.escList.length;i++)if(a.s.keymng.escList[i].token==t){a.s.keymng.escList.splice(i,1);break}}},createToken:function(){return Math.random().toString(36).substr(2)}};return t}();var tpl={run:function(t){var e=t.tpl||"",a=t.data||{},n=t.cb||function(t){};this.get_tpl(e,(function(t){n(ejs.render(t,a))}))},get_tpl:function(t,e){var a=tpl.search_cache(t);a?e(a):$.get({url:t,success:function(a){tpl.tpl_cache.push({path:t,data:a}),e(a)}})},search_cache:function(t){var e=!1;for(var a in tpl.tpl_cache){tpl.tpl_cache[a].path==t&&(e=tpl.tpl_cache[a].data);break}return e||!1},tpl_cache:[]};function add3Dots(t,e){return t.length>e&&(t=t.substring(0,e-3)+"..."),t}a.blog=function(){var t={loaderContent:'<div class="inline-loader"><span class="spinner">&#9696;</span></div>',loaderContentMini:'<div class="inline-loader mini"><span class="spinner">&#9696;</span></div>',listPage:function(){tpl.run({tpl:"./tpl/blog/listpage.ejs",data:{},cb:function(e){$("#body").empty().append(e),$('#body button[data-action="create"]').unbind("click").click((function(){t.createPost()})),$('#body select[data-filter="display"]').unbind("change").change((function(){t.listPosts()})),t.listPosts()}})},listPosts:function(){$('#body div[data-area="list"]').empty().append(t.loaderContent),$.ajax({type:"GET",url:"./api/blog/list/",data:{display:$('#body select[data-filter="display"]').val()},dataType:"json",cache:!1,success:function(t){t.success?tpl.run({tpl:"./tpl/blog/list.ejs",data:t,cb:function(t){$('#body div[data-area="list"]').empty().append(t)}}):a.s.growl.create("Error","Error loading posts from API",{})}}).done((function(){}))},createPost:function(){var t=prompt("Blog post title:","");null!=t&&t.length>0&&(a.s.loader.fs.create(),$.ajax({type:"POST",url:"./api/blog/create/",data:{title:t},dataType:"json",cache:!1,success:function(t){t.success&&t.id?location.hash="#/blog/edit/"+t.id+"/":alert("Error creating blog post")}}).done((function(){a.s.loader.fs.remove()})))}};return t}(),a.blog.edit=function(){var t={editPage:function(e){a.s.loader.fs.create(),$.ajax({type:"GET",url:"./api/blog/load/",data:{id:e},dataType:"json",cache:!1,success:function(n){n.success&&n.data?tpl.run({tpl:"./tpl/blog/edit.ejs",data:n,cb:function(n){$("#body").empty().append(n),setTimeout((function(){a.s.tabbox.init(),t.initCharCounter($('small[data-area="charcount-heading"]'),50,100),t.initCharCounter($('small[data-area="charcount-title"]'),50,60),t.initCharCounter($('small[data-area="charcount-meta-description"]'),100,160),t.initSERP(),t.initEditor(e),t.relatedList.init(e),$('form[name="edit_post"], button[data-action="btn-none"]').submit((function(t){return t.preventDefault(),!1})),$('button[data-action="select-main-image"]').unbind("click").click((function(){a.blog.imgpicker.create(e,(function(t){$('input[name="img"]').val(t)}),!1,!0)})),$('input[type="checkbox"][name="published"]').unbind("change").change((function(){$(this).is(":checked")?t.publishPost(e):t.unpublishPost(e)})),$('button[data-action="save-content"]').unbind("click").click((function(){t.saveContent()})),$('button[data-action="save-notes"]').unbind("click").click((function(){t.saveNotes()})),$('button[data-action="save-options"]').unbind("click").click((function(){t.saveOptions()})),$('button[data-action="delete"]').unbind("click").click((function(){t.deletePost(e)}))}),100)}}):location.hash="/blog/list/"}}).done((function(){a.s.loader.fs.remove()}))},saveContent:function(){a.s.loader.fs.create(),tinyMCE.triggerSave(),setTimeout((function(){$.ajax({type:"POST",url:"./api/blog/save/content/",data:$('form[name="edit_post"]').serialize(),dataType:"json",cache:!1,success:function(t){t.success?a.s.growl.create("Success","The changes was saved.",{}):a.s.growl.create("Error","Unable to save changes. Reload and try again.",{})}}).done((function(){a.s.loader.fs.remove()}))}),100)},saveNotes:function(){a.s.loader.fs.create(),tinyMCE.triggerSave(),setTimeout((function(){$.ajax({type:"POST",url:"./api/blog/save/notes/",data:$('form[name="edit_post"]').serialize(),dataType:"json",cache:!1,success:function(t){t.success?a.s.growl.create("Success","The changes was saved.",{}):a.s.growl.create("Error","Unable to save changes. Reload and try again.",{})}}).done((function(){a.s.loader.fs.remove()}))}),100)},saveOptions:function(){a.s.loader.fs.create(),tinyMCE.triggerSave(),setTimeout((function(){$.ajax({type:"POST",url:"./api/blog/save/options/",data:$('form[name="edit_post"]').serialize(),dataType:"json",cache:!1,success:function(t){t.success?a.s.growl.create("Success","The changes was saved.",{}):a.s.growl.create("Error","Unable to save changes. Reload and try again.",{})}}).done((function(){a.s.loader.fs.remove()}))}),100)},publishPost:function(t){$.ajax({type:"POST",url:"./api/blog/publish/",data:{id:t},dataType:"json",cache:!1,success:function(t){t.success?a.s.growl.create("Success","The blog post has been published",{}):a.s.growl.create("Error","Unable to publish blog post",{})}})},unpublishPost:function(t){$.ajax({type:"POST",url:"./api/blog/unpublish/",data:{id:t},dataType:"json",cache:!1,success:function(t){t.success?a.s.growl.create("Success","The blog post has been unpublished",{}):a.s.growl.create("Error","Unable to unpublish blog post",{})}})},deletePost:function(t){confirm("Do you really want to delete this blog post?")&&(a.s.loader.fs.create(),$.ajax({type:"POST",url:"./api/blog/delete/",data:{id:t},dataType:"json",cache:!1,success:function(t){t.success?(a.s.growl.create("Success","The blog post has been deleted",{}),location.hash="/blog/list/"):a.s.growl.create("Error",t.error,{})}}).done((function(){a.s.loader.fs.remove()})))},initCharCounter:function(e,a,n){$(">input",$(e).parent()).length?($(">input",$(e).parent()).keyup((function(){t.charCount($(this),a,n)})),t.charCount($(">input",$(e).parent()),a,n)):($(">textarea",$(e).parent()).keyup((function(){t.charCount($(this),a,n)})),t.charCount($(">textarea",$(e).parent()),a,n))},charCount:function(t,e,a){var n,i=!1,o=!1,s=0,c="",l="#000";(n=$(t).val().length)<e?(i=!1,o=!0,s=n-e,s=String(s)):n>a?(i=!0,o=!1,s=n-a,s=String("+"+s)):(i=!1,o=!1,s=0,s=String(s)),i||o?o?(c="Character count: "+n+" (too short by "+s+")",l="orange"):(c="Character count: "+n+" (too long by "+s+")",l="red"):(c="Character count: "+n+" (ideal length)",l="green"),$(">small",t.parent()).css("color",l).html(c)},initSERP:function(){$('input[name="meta_title"]').keyup((function(){t.updateSERP()})),$('textarea[name="meta_description"]').keyup((function(){t.updateSERP()})),t.updateSERP()},updateSERP:function(){var t=$('input[name="meta_title"]').val(),e=$('textarea[name="meta_description"]').val();$(".gsr>h2").html(add3Dots(t,60)),$(".gsr>p").html(add3Dots(e,140))},initEditor:function(t){tinymce.init({selector:"textarea.tinymce",height:500,plugins:"preview searchreplace autolink directionality visualblocks visualchars fullscreen image link media template codesample table charmap hr pagebreak nonbreaking anchor toc insertdatetime advlist lists wordcount imagetools textpattern help code",toolbar1:"formatselect | bold italic strikethrough forecolor backcolor | link unlink image | alignleft aligncenter alignright alignjustify  | numlist bullist outdent indent  | removeformat | fullscreen code",image_advtab:!0,image_caption:!0,image_dimensions:!1,relative_urls:!1,content_css:[],image_title:!0,file_picker_types:"image file media",file_picker_callback:function(e,n,i){"file"==i.filetype?a.blog.pagepicker.create(e):a.blog.imgpicker.create(t,e,!0,!1)}})},relatedList:{init:function(e){t.relatedList.search(e),t.relatedList.listRelated(e),$('button[data-action="search-rel"]').unbind("click").click((function(){t.relatedList.search(e)})),$('input[name="rel-q"]').keypress((function(a){13==a.keyCode&&t.relatedList.search(e)}))},search:function(e){$('#body div[data-area="related-search-result"]').empty().append(a.blog.loaderContentMini),$.ajax({type:"GET",url:"./api/blog/list/",data:{skipid:e,q:$('input[name="rel-q"]').val(),limit:25},dataType:"json",cache:!1,success:function(n){n.success?tpl.run({tpl:"./tpl/blog/edit/related-search-result-list.ejs",data:n,cb:function(a){$('#body div[data-area="related-search-result"]').empty().append(a),setTimeout((function(){$('button[data-action="add-related"]').unbind("click").click((function(){t.relatedList.addRel(e,$(this).attr("data-id"))}))}),100)}}):a.s.growl.create("Error","Error loading posts from API",{})}})},listRelated:function(e){$.ajax({type:"GET",url:"./api/blog/rel/list/",data:{id:e},dataType:"json",cache:!1,success:function(n){n.success?tpl.run({tpl:"./tpl/blog/edit/related-list.ejs",data:n,cb:function(a){$('#body div[data-area="relatedlist"]').empty().append(a),setTimeout((function(){$('button[data-action="delete-related"]').unbind("click").click((function(){t.relatedList.deleteRel(e,$(this).attr("data-id"))})),$('div[data-area="relatedlist"]>ul').sortable({handle:">div>i",stop:function(a,n){t.relatedList.changeOrder(e)}})}),100)}}):a.s.growl.create("Error","Error loading related posts from API",{})}})},addRel:function(e,a){$.ajax({type:"POST",url:"./api/blog/rel/add/",data:{id:e,relid:a},dataType:"json",cache:!1,success:function(a){t.relatedList.listRelated(e)}})},deleteRel:function(e,a){$.ajax({type:"POST",url:"./api/blog/rel/delete/",data:{id:e,relid:a},dataType:"json",cache:!1,success:function(a){t.relatedList.listRelated(e)}})},changeOrder:function(t){var e=[];$.when($('div[data-area="relatedlist"]>ul>li').each((function(t,a){e[t]=$(a).attr("data-id")}))).then((function(){$.ajax({type:"POST",url:"./api/blog/rel/order/",data:{id:t,order:e.join(",")},dataType:"json",cache:!1,success:function(t){t.success?a.s.growl.create("Success","Related articles was sucessfully reordered",{}):a.s.growl.create("Success","Unable to save reorder. Reload page and try again.",{})}})}))}},gotoPost:function(t){$.ajax({type:"GET",url:"./api/blog/load/",data:{id:t},dataType:"json",cache:!1,success:function(t){t.success&&t.data&&(use_date_in_url?window.open("/blog/post/"+t.data.pubdate+"/"+t.data.url_path+"/"):window.open("/blog/post/"+t.data.url_path+"/"))}}).done((function(){}))}};return t}(),a.blog.imgpicker=function(){var t={create:function(e,n,i,o){a.s.popup.create({title:"Select image",width:900,height:500,content:a.blog.loaderContent,ready:function(a){tpl.run({tpl:"./tpl/blog/imgpicker/main.ejs",data:{},cb:function(s){$("#popupid_"+a+" .ic").empty().append(s),setTimeout((function(){t.listFiles(e,a,n,i,o),$("#imgselector").unbind("change").change((function(){t.uploadFiles(e,this.files,$("#popupid_"+a),(function(){$("#imgselector").val(""),t.listFiles(e,a,n,i,o)}))}))}),100)}})}})},listFiles:function(t,e,n,i,o){var s=$("#popupid_"+e+' div[data-area="imglist"]');$.ajax({type:"GET",url:"./api/blog/image/list/",data:{id:t},dataType:"json",cache:!1,success:function(t){t.success?tpl.run({tpl:"./tpl/blog/imgpicker/list.ejs",data:t,cb:function(t){$(s).empty().append(t),setTimeout((function(){$('li[data-action="select"]').unbind("click").click((function(){n(o?$(this).attr("data-filename"):a.sitesettings.basepath+"/img/full/"+$(this).attr("data-filename"),{}),a.s.popup.remove(e,(function(){}))}))}),100)}}):a.s.growl.create("Error","Unable to load images",{})}})},uploadFiles:function(e,a,n,i){if(a.length>0){var o=a.length,s=0;$(a).each((function(a,c){t.uploadFile(e,c,n,(function(){++s===o&&i()}))}))}},uploadFile:function(t,e,n,i){var o="fileupload_"+a.s.createToken();c='<li class="file" id="'+o+'">',c+='<div class="info">',c+='<span class="pct" data-fileupload-area="pct">1%</span><span class="filename">'+e.name.substring(0,50)+"</span>",c+='<i class="icon" style="font-style:normal;" data-fileupload-action="close">&times;</i>',c+="</div>",c+='<div class="prog"><div class="bar" style="width:1%;" data-fileupload-area="progbar"></div></div>',c+="</li>",$("ul.uploadlist",n).append(c);var s=$("#"+o),l=$("#"+o+' span[data-fileupload-area="pct"]'),r=$("#"+o+' div[data-fileupload-area="progbar"]'),d=$("#"+o+' i[data-fileupload-action="close"]'),u=new FormData;u.append("id",t),u.append("file",e);var p=$.ajax({type:"POST",url:"./api/blog/image/upload/",data:u,processData:!1,contentType:!1,dataType:"json",xhr:function(){var t=new window.XMLHttpRequest;return t.upload.addEventListener("progress",(function(t){if(t.lengthComputable){var e=Math.round(t.loaded/t.total*100);$(l).text(e+"%"),$(r).css("width",e+"%")}}),!1),t},success:function(t){t.success?($('span[data-fileupload-area="pct"]',s).text("Done!"),setTimeout((function(){s.remove(),i(!1)}),1e3)):($('span[data-fileupload-area="pct"]',s).text("Error!"),setTimeout((function(){s.remove(),i(!1)}),1500))}}).done((function(){}));$(d).unbind("click").click((function(){p.abort(),s.remove(),i(!1)}))}};return t}(),a.blog.pagepicker=function(){var t={create:function(e){a.s.popup.create({title:"Select page",width:900,height:500,content:a.blog.loaderContent,ready:function(a){tpl.run({tpl:"./tpl/blog/pagepicker/main.ejs",data:{},cb:function(n){$("#popupid_"+a+" .ic").empty().append(n),setTimeout((function(){t.listPages(a,e),$("#popupid_"+a+' select[data-filter="display"]').unbind("change").change((function(){t.listPages(a,e)}))}),100)}})}})},listPages:function(t,e){var n=$("#popupid_"+t+' div[data-area="pagelist"]');$(n).empty().append(a.blog.loaderContent),$.ajax({type:"GET",url:"./api/blog/list/",data:{display:$("#popupid_"+t+' select[data-filter="display"]').val()},dataType:"json",cache:!1,success:function(i){i.success?tpl.run({tpl:"./tpl/blog/pagepicker/list.ejs",data:i,cb:function(i){$(n).empty().append(i),setTimeout((function(){$('button[data-action="select"]').unbind("click").click((function(){if(console.log(a.sitesettings),a.sitesettings.use_date_in_url)var n=a.sitesettings.basepath+"/post/"+$(this).attr("data-pubdate")+"/"+$(this).attr("data-path")+"/";else n=a.sitesettings.basepath+"/post/"+$(this).attr("data-path")+"/";e(n,{id:$(this).attr("data-id"),title:$(this).attr("data-title")}),a.s.popup.remove(t,(function(){}))}))}),100)}}):a.s.growl.create("Error","Unable to load pages",{})}})}};return t}(),a.router.init();